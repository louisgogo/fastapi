# SQL2Dataå·¥ä½œæµä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

SQL2Dataå·¥ä½œæµæ˜¯ä¸€ä¸ªå®Œæ•´çš„æ•°æ®åˆ†æè§£å†³æ–¹æ¡ˆï¼Œå®ƒå¯ä»¥ï¼š

1. **è‡ªç„¶è¯­è¨€è½¬SQL**ï¼šå°†ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€æŸ¥è¯¢è½¬æ¢ä¸ºSQLè¯­å¥
2. **æ•°æ®æŸ¥è¯¢æ‰§è¡Œ**ï¼šæ‰§è¡Œç”Ÿæˆçš„SQLè¯­å¥è·å–æ•°æ®
3. **æ•°æ®å¤„ç†åˆ†æ**ï¼šä½¿ç”¨pandaså¤„ç†å’Œåˆ†ææ•°æ®
4. **æ™ºèƒ½æŠ¥å‘Šç”Ÿæˆ**ï¼šä½¿ç”¨LLMç”Ÿæˆä¸“ä¸šçš„è´¢åŠ¡åˆ†ææŠ¥å‘Š

## ç³»ç»Ÿæ¶æ„

```mermaid
graph TD
    A[ç”¨æˆ·è‡ªç„¶è¯­è¨€æŸ¥è¯¢] --> B[NL2SQLå·¥ä½œæµ]
    B --> C[SQLè¯­å¥ç”Ÿæˆ]
    C --> D[SQLæ‰§è¡Œå¼•æ“]
    D --> E[åŸå§‹æ•°æ®]
    E --> F[Pandasæ•°æ®å¤„ç†]
    F --> G[ç»“æ„åŒ–æ•°æ®]
    G --> H[LLMåˆ†ææŠ¥å‘Šç”Ÿæˆ]
    H --> I[è´¢åŠ¡åˆ†ææŠ¥å‘Š]
```

## åŠŸèƒ½ç‰¹æ€§

### ğŸ”„ NL2SQLè½¬æ¢
- æ”¯æŒä¸­æ–‡è‡ªç„¶è¯­è¨€æŸ¥è¯¢
- æ™ºèƒ½è¯†åˆ«æ¶‰åŠçš„æ•°æ®è¡¨
- è‡ªåŠ¨ç”Ÿæˆä¼˜åŒ–çš„SQLè¯­å¥
- SQLè¯­æ³•éªŒè¯å’Œé”™è¯¯å¤„ç†

### ğŸ“Š æ•°æ®å¤„ç†
- ä½¿ç”¨pandasè¿›è¡Œé«˜æ•ˆæ•°æ®å¤„ç†
- è‡ªåŠ¨ç»Ÿè®¡åˆ†æï¼ˆæè¿°æ€§ç»Ÿè®¡ã€åˆ†å¸ƒåˆ†æç­‰ï¼‰
- æ•°æ®ç±»å‹è¯†åˆ«å’Œè½¬æ¢
- æ—¶é—´åºåˆ—æ•°æ®åˆ†æ

### ğŸ¤– æ™ºèƒ½åˆ†æ
- åŸºäºLLMçš„ä¸“ä¸šè´¢åŠ¡åˆ†æ
- è‡ªåŠ¨è¯†åˆ«å…³é”®æŒ‡æ ‡å’Œè¶‹åŠ¿
- é£é™©è¯†åˆ«å’Œå»ºè®®æªæ–½
- ç»“æ„åŒ–çš„åˆ†ææŠ¥å‘Šæ ¼å¼

## ç¯å¢ƒè¦æ±‚

### ä¾èµ–åŒ…
```bash
# æ ¸å¿ƒæ¡†æ¶
fastapi>=0.104.0
uvicorn[standard]>=0.24.0

# æ•°æ®åº“
asyncpg>=0.29.0
psycopg2-binary>=2.9.0

# æ•°æ®å¤„ç†
pandas>=2.1.0

# AIå’Œå·¥ä½œæµ
langgraph>=0.0.60
langchain>=0.1.0

# å…¶ä»–ä¾èµ–
pydantic>=2.5.0
httpx>=0.25.0
```

### æ•°æ®åº“é…ç½®
ç¡®ä¿PostgreSQLæ•°æ®åº“é…ç½®æ­£ç¡®ï¼š
```env
PSQL_DB_HOST=localhost
PSQL_DB_PORT=5432
PSQL_DB_NAME=your_database
PSQL_DB_USER=your_user
PSQL_DB_PASSWORD=your_password
```

## ä½¿ç”¨æ–¹æ³•

### 1. APIæ¥å£è°ƒç”¨

#### è´¢åŠ¡åˆ†ææŠ¥å‘ŠAPI
```http
POST /api/v1/workflows/financial-analysis
Content-Type: application/json

{
    "query": "è¯·åˆ†æèƒ½æºäº‹ä¸šä¸­å¿ƒ2025å¹´1-4æœˆçš„æŸç›Šæƒ…å†µ"
}
```

#### å“åº”æ ¼å¼
```json
{
    "success": true,
    "message": "è´¢åŠ¡åˆ†ææŠ¥å‘Šç”ŸæˆæˆåŠŸ",
    "data": {
        "query": "è¯·åˆ†æèƒ½æºäº‹ä¸šä¸­å¿ƒ2025å¹´1-4æœˆçš„æŸç›Šæƒ…å†µ",
        "sql_count": 2,
        "data_count": 150,
        "analysis_report": "# è´¢åŠ¡åˆ†ææŠ¥å‘Š\n\n## æ•°æ®æ¦‚è§ˆ\n...",
        "sql_list": [
            "SELECT * FROM fact_profit WHERE...",
            "SELECT * FROM fact_revenue WHERE..."
        ]
    }
}
```

### 2. ç¼–ç¨‹æ¥å£è°ƒç”¨

#### ç®€å•è°ƒç”¨
```python
from app.workflows.langgraph.sql2data import generate_financial_analysis_report

# å¼‚æ­¥è°ƒç”¨
result = await generate_financial_analysis_report("æŸ¥è¯¢2025å¹´ç¬¬ä¸€å­£åº¦çš„æ”¶å…¥æƒ…å†µ")

if result.get('success'):
    print("åˆ†ææŠ¥å‘Šï¼š")
    print(result.get('analysis_report'))
else:
    print("é”™è¯¯ï¼š", result.get('error'))
```

#### é«˜çº§è°ƒç”¨
```python
from app.workflows.langgraph.sql2data import SQL2DataWorkflow

# åˆ›å»ºå·¥ä½œæµå®ä¾‹
workflow = SQL2DataWorkflow("è¯·åˆ†æå„éƒ¨é—¨çš„è´¹ç”¨åˆ†å¸ƒæƒ…å†µ")

# æ‰§è¡Œå·¥ä½œæµ
result = await workflow.execute_async({})

# å¤„ç†ç»“æœ
if result.get('success'):
    print(f"ç”Ÿæˆäº† {len(result.get('sql_list', []))} ä¸ªSQLè¯­å¥")
    print(f"å¤„ç†äº† {result.get('raw_data_count', 0)} è¡Œæ•°æ®")
    print("åˆ†ææŠ¥å‘Šï¼š", result.get('analysis_report'))
```

### 3. ç›´æ¥ä½¿ç”¨ç»„ä»¶

#### æ‰‹åŠ¨æŒ‡å®šSQL
```python
from app.workflows.langgraph.sql2data import DataAnalysisState, compiled_data_workflow

# åˆ›å»ºåˆå§‹çŠ¶æ€
initial_state = DataAnalysisState(
    query="æ‰‹åŠ¨æ•°æ®åˆ†æ",
    sql_list=[
        "SELECT department, SUM(amount) FROM expenses GROUP BY department",
        "SELECT month, SUM(revenue) FROM revenue_table GROUP BY month"
    ]
)

# æ‰§è¡Œæ•°æ®åˆ†æå·¥ä½œæµ
result = await compiled_data_workflow.ainvoke(initial_state)

# è·å–ç»“æœ
if not result.error_message:
    print("æ•°æ®å¤„ç†æˆåŠŸ")
    print("åˆ†ææŠ¥å‘Šï¼š", result.analysis_report)
```

## æŸ¥è¯¢ç¤ºä¾‹

### è´¢åŠ¡åˆ†ææŸ¥è¯¢
```python
queries = [
    "åˆ†æ2025å¹´ç¬¬ä¸€å­£åº¦çš„åˆ©æ¶¦æƒ…å†µ",
    "å¯¹æ¯”å„éƒ¨é—¨çš„è´¹ç”¨æ”¯å‡ºæƒ…å†µ",
    "æŸ¥çœ‹èƒ½æºäº‹ä¸šä¸­å¿ƒçš„æ”¶å…¥è¶‹åŠ¿",
    "è¯„ä¼°å…¬å¸æ•´ä½“è´¢åŠ¡å¥åº·çŠ¶å†µ",
    "åˆ†æå„äº§å“çº¿çš„ç›ˆåˆ©èƒ½åŠ›"
]

for query in queries:
    result = await generate_financial_analysis_report(query)
    print(f"æŸ¥è¯¢ï¼š{query}")
    print(f"ç»“æœï¼š{result.get('success')}")
```

### æ•°æ®æ¢ç´¢æŸ¥è¯¢
```python
exploration_queries = [
    "æ•°æ®åº“ä¸­æœ‰å“ªäº›è¡¨æ ¼ï¼Ÿ",
    "å„ä¸ªè¡¨çš„æ•°æ®é‡æ˜¯å¤šå°‘ï¼Ÿ",
    "æœ€è¿‘ä¸€ä¸ªæœˆçš„æ•°æ®æ›´æ–°æƒ…å†µ",
    "æ•°æ®è´¨é‡æ£€æŸ¥å’Œå¼‚å¸¸å€¼åˆ†æ"
]
```

## æµ‹è¯•å’ŒéªŒè¯

### è¿è¡Œæµ‹è¯•è„šæœ¬
```bash
cd AIPlatform
python test_sql2data_workflow.py
```

### æµ‹è¯•è¦†ç›–
- âœ… æ•°æ®åº“è¿æ¥æµ‹è¯•
- âœ… SQLæ‰§è¡Œæµ‹è¯•  
- âœ… Pandasæ•°æ®å¤„ç†æµ‹è¯•
- âœ… å·¥ä½œæµé›†æˆæµ‹è¯•
- âœ… åˆ†ææŠ¥å‘Šç”Ÿæˆæµ‹è¯•

## å¸¸è§é—®é¢˜

### Q1: SQLç”Ÿæˆå¤±è´¥
**é—®é¢˜**ï¼šNL2SQLæ— æ³•ç”Ÿæˆæœ‰æ•ˆçš„SQLè¯­å¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥æŸ¥è¯¢è¯­è¨€æ˜¯å¦æ¸…æ™°æ˜ç¡®
2. ç¡®è®¤æ•°æ®åº“è¡¨ç»“æ„ä¿¡æ¯æ˜¯å¦å®Œæ•´
3. éªŒè¯LLMæ¨¡å‹æ˜¯å¦æ­£å¸¸è¿è¡Œ

### Q2: æ•°æ®åº“è¿æ¥å¤±è´¥
**é—®é¢˜**ï¼šæ— æ³•è¿æ¥åˆ°PostgreSQLæ•°æ®åº“

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥æ•°æ®åº“æœåŠ¡æ˜¯å¦å¯åŠ¨
2. éªŒè¯è¿æ¥é…ç½®å‚æ•°
3. ç¡®è®¤ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®

### Q3: åˆ†ææŠ¥å‘Šè´¨é‡ä¸ä½³
**é—®é¢˜**ï¼šç”Ÿæˆçš„åˆ†ææŠ¥å‘Šä¸å¤Ÿä¸“ä¸šæˆ–å‡†ç¡®

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä¼˜åŒ–æç¤ºè¯æ¨¡æ¿
2. å¢åŠ æ›´å¤šçš„æ•°æ®é¢„å¤„ç†
3. è°ƒæ•´LLMæ¨¡å‹å‚æ•°

### Q4: æ€§èƒ½é—®é¢˜
**é—®é¢˜**ï¼šå¤§æ•°æ®é‡å¤„ç†æ—¶æ€§èƒ½è¾ƒæ…¢

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä¼˜åŒ–SQLæŸ¥è¯¢è¯­å¥
2. å¢åŠ æ•°æ®åˆ†é¡µå¤„ç†
3. ä½¿ç”¨æ•°æ®é‡‡æ ·æ–¹æ³•
4. é…ç½®æ›´é«˜æ€§èƒ½çš„ç¡¬ä»¶

## æ‰©å±•åŠŸèƒ½

### è‡ªå®šä¹‰åˆ†ææ¨¡æ¿
```python
# åˆ›å»ºè‡ªå®šä¹‰åˆ†ææç¤ºè¯
custom_prompt = """
ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„è´¢åŠ¡åˆ†æå¸ˆï¼Œä¸“é—¨åˆ†æ{industry}è¡Œä¸šçš„è´¢åŠ¡æ•°æ®ã€‚
è¯·é‡ç‚¹å…³æ³¨ä»¥ä¸‹æŒ‡æ ‡ï¼š
1. è¥æ”¶å¢é•¿ç‡
2. åˆ©æ¶¦ç‡å˜åŒ–
3. æˆæœ¬æ§åˆ¶æ•ˆæœ
4. ç°é‡‘æµçŠ¶å†µ
...
"""

# åœ¨å·¥ä½œæµä¸­ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ¿
# ï¼ˆéœ€è¦ä¿®æ”¹generate_analysis_reportå‡½æ•°ï¼‰
```

### æ‰¹é‡åˆ†æå¤„ç†
```python
async def batch_analysis(queries):
    """æ‰¹é‡å¤„ç†å¤šä¸ªæŸ¥è¯¢"""
    results = []
    for query in queries:
        result = await generate_financial_analysis_report(query)
        results.append(result)
    return results

# ä½¿ç”¨ç¤ºä¾‹
batch_queries = [
    "åˆ†æQ1è´¢åŠ¡çŠ¶å†µ",
    "åˆ†æQ2è´¢åŠ¡çŠ¶å†µ", 
    "åˆ†æQ3è´¢åŠ¡çŠ¶å†µ",
    "åˆ†æQ4è´¢åŠ¡çŠ¶å†µ"
]

batch_results = await batch_analysis(batch_queries)
```

### æŠ¥å‘Šå¯¼å‡ºåŠŸèƒ½
```python
def export_report(report_content, format="markdown"):
    """å¯¼å‡ºåˆ†ææŠ¥å‘Š"""
    if format == "markdown":
        with open("financial_report.md", "w", encoding="utf-8") as f:
            f.write(report_content)
    elif format == "pdf":
        # ä½¿ç”¨æŠ¥å‘Šç”Ÿæˆåº“ï¼ˆå¦‚reportlabï¼‰
        pass
    elif format == "excel":
        # ä½¿ç”¨pandaså¯¼å‡ºåˆ°Excel
        pass
```

## æœ€ä½³å®è·µ

### 1. æŸ¥è¯¢ä¼˜åŒ–
- ä½¿ç”¨å…·ä½“æ˜ç¡®çš„æŸ¥è¯¢è¯­è¨€
- æŒ‡å®šæ—¶é—´èŒƒå›´å’Œæ•°æ®èŒƒå›´
- é¿å…è¿‡äºå¤æ‚çš„å¤åˆæŸ¥è¯¢

### 2. æ€§èƒ½ä¼˜åŒ–
- åˆç†è®¾ç½®æ•°æ®åº“è¿æ¥æ± 
- ä½¿ç”¨æ•°æ®ç¼“å­˜æœºåˆ¶
- å¯¹å¤§å‹æ•°æ®é›†è¿›è¡Œåˆ†é¡µå¤„ç†

### 3. å®‰å…¨è€ƒè™‘
- éªŒè¯ç”¨æˆ·è¾“å…¥
- é™åˆ¶SQLæ‰§è¡Œæƒé™
- å®æ–½æ•°æ®è®¿é—®æ§åˆ¶

### 4. ç›‘æ§å’Œæ—¥å¿—
- è®°å½•å·¥ä½œæµæ‰§è¡Œæ—¥å¿—
- ç›‘æ§ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡
- è®¾ç½®å¼‚å¸¸å‘Šè­¦æœºåˆ¶

## æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
2. è¿è¡Œæµ‹è¯•è„šæœ¬è¯Šæ–­
3. è”ç³»æŠ€æœ¯æ”¯æŒå›¢é˜Ÿ

---

**ä½œè€…**: malou  
**åˆ›å»ºæ—¶é—´**: 2025-01-08  
**ç‰ˆæœ¬**: 1.0.0 