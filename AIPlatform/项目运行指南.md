# AI API Platform 项目运行指南

## 1. 项目概述

### 1.1 项目简介
AI API Platform 是一个基于FastAPI构建的AI能力服务平台，专为财务部门提供统一的AI API接口。项目采用现代化的技术栈，支持自然语言转PSQL、反馈数据收集等核心功能，具备良好的扩展性。

### 1.2 主要功能
- **自然语言转SQL (NL2SQL)**: 将自然语言查询转换为PostgreSQL语句
- **API密钥管理**: 提供完整的API密钥生命周期管理
- **用户管理**: 用户注册、权限管理、使用统计
- **反馈收集**: 收集用户对AI服务的使用反馈
- **日志监控**: 完整的API调用日志和系统监控
- **Agent管理**: AI智能体的配置和管理

### 1.3 技术架构
- **后端框架**: FastAPI (Python 3.11+)
- **数据库**: PostgreSQL
- **AI框架**: LangGraph + OLLAMA
- **缓存**: Redis
- **容器化**: Docker + Docker Compose
- **API文档**: Swagger/OpenAPI

### 1.4 API接口文档
详细的API接口文档请参考：[API接口文档.md](./API接口文档.md)

该文档包含：
- 完整的API接口列表
- 请求/响应参数说明
- 错误码定义
- 认证授权说明
- 示例代码和调用说明

## 2. 环境配置

### 2.1 系统要求
- **Python**: 3.11 或更高版本
- **PostgreSQL**: 13.0 或更高版本
- **Redis**: 6.0 或更高版本
- **OLLAMA**: 最新版本
- **Docker**: 20.10 或更高版本 (可选)
- **内存**: 至少 4GB
- **存储**: 至少 10GB 可用空间

### 2.2 依赖安装

#### 方法一：直接安装
```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
# Windows
venv\Scripts\activate
# Linux/Mac
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```

#### 方法二：使用Poetry (推荐)
```bash 
# 安装Poetry
curl -sSL https://install.python-poetry.org | python3 -

# 安装项目依赖
poetry install

# 激活虚拟环境
poetry shell
```

### 2.3 环境变量配置

#### 创建 .env 文件
```bash
cp env.example .env
```

#### 配置必要的环境变量
```bash
# 应用配置
APP_NAME=AI API Platform
APP_VERSION=1.0.0
APP_DEBUG=true
APP_HOST=0.0.0.0
APP_PORT=8000

# 安全配置
SECRET_KEY=your-secret-key-here-must-be-at-least-32-characters
API_KEY_EXPIRE_DAYS=365

# 数据库配置
DATABASE_URL=postgresql://username:password@localhost:5432/ai_platform
DATABASE_ECHO=false

# OLLAMA配置
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_DEFAULT_MODEL=llama3.2
OLLAMA_TIMEOUT=30

# Redis配置
REDIS_URL=redis://localhost:6379/0

# 日志配置
LOG_LEVEL=INFO
LOG_FILE=logs/app.log
```

## 3. 代码结构

### 3.1 项目目录结构
```
AIPlatform/
├── app/                          # 主应用代码
│   ├── api/                      # API路由
│   │   └── v1/                   # API v1版本
│   │       ├── agents.py         # Agent相关API
│   │       ├── api_keys.py       # API密钥管理API
│   │       ├── feedback.py       # 反馈相关API
│   │       ├── health.py         # 健康检查API
│   │       ├── logs.py           # 日志查询API
│   │       ├── users.py          # 用户管理API
│   │       └── router.py         # 路由汇总
│   ├── agents/                   # AI Agent实现
│   │   ├── base_agent.py         # Agent基类
│   │   └── nl2sql_agent.py       # NL2SQL Agent
│   ├── core/                     # 核心配置
│   │   ├── config.py             # 应用配置
│   │   └── exceptions.py         # 异常定义
│   ├── database/                 # 数据库相关
│   │   ├── connection.py         # 数据库连接
│   │   └── session.py            # 会话管理
│   ├── middleware/               # 中间件
│   │   ├── auth.py               # 认证中间件
│   │   └── logging.py            # 日志中间件
│   ├── models/                   # 数据模型
│   │   ├── base.py               # 基础模型
│   │   ├── user.py               # 用户模型
│   │   ├── api_key.py            # API密钥模型
│   │   ├── agent.py              # Agent模型
│   │   ├── api_log.py            # API日志模型
│   │   └── feedback.py           # 反馈模型
│   ├── schemas/                  # Pydantic模式
│   │   ├── common.py             # 通用模式
│   │   ├── user.py               # 用户模式
│   │   ├── api_key.py            # API密钥模式
│   │   ├── agent.py              # Agent模式
│   │   └── feedback.py           # 反馈模式
│   ├── services/                 # 业务服务
│   │   ├── user_service.py       # 用户服务
│   │   ├── api_key_service.py    # API密钥服务
│   │   ├── agent_service.py      # Agent服务
│   │   ├── feedback_service.py   # 反馈服务
│   │   └── ollama_service.py     # OLLAMA服务
│   ├── utils/                    # 工具类
│   │   └── logger.py             # 日志工具
│   └── main.py                   # 应用入口
├── tests/                        # 测试代码
│   ├── conftest.py               # 测试配置
│   ├── test_health.py            # 健康检查测试
│   ├── test_agents.py            # Agent测试
│   ├── test_users.py             # 用户测试
│   └── test_api_keys.py          # API密钥测试
├── scripts/                      # 脚本文件
│   ├── init_db.py                # 数据库初始化
│   └── start.py                  # 启动脚本
├── doc/                          # 项目文档
├── docker-compose.yml            # Docker编排
├── Dockerfile                    # Docker镜像
├── requirements.txt              # Python依赖
├── pyproject.toml                # 项目配置
└── README.md                     # 项目说明
```

### 3.2 核心模块说明

#### 3.2.1 API模块 (app/api/)
- **功能**: 提供RESTful API接口
- **职责**: 请求处理、参数验证、响应格式化
- **依赖**: schemas、services

#### 3.2.2 Agent模块 (app/agents/)
- **功能**: AI智能体实现
- **职责**: 自然语言处理、模型调用、结果生成
- **依赖**: ollama_service、LangGraph

#### 3.2.3 服务模块 (app/services/)
- **功能**: 业务逻辑处理
- **职责**: 数据操作、业务规则、外部服务调用
- **依赖**: models、数据库会话

#### 3.2.4 模型模块 (app/models/)
- **功能**: 数据库模型定义
- **职责**: 数据结构、关系定义、数据验证
- **依赖**: SQLAlchemy

## 4. 模块运行指南

### 4.1 健康检查模块

#### 4.1.1 模块功能描述
提供系统健康状态检查，包括数据库连接、OLLAMA服务状态等。

#### 4.1.2 运行入口
```bash
# 直接测试健康检查模块
python -m app.api.v1.health
```

#### 4.1.3 依赖项
- FastAPI
- SQLAlchemy
- 数据库连接

#### 4.1.4 参数配置
无需额外配置，使用默认环境变量。

#### 4.1.5 运行命令示例
```bash
# 启动完整应用后访问
curl http://localhost:8000/health

# 或者通过浏览器访问
http://localhost:8000/health
```

#### 4.1.6 预期输出
```json
{
  "status": "healthy",
  "version": "1.0.0",
  "timestamp": 1703001234.5,
  "database": "connected",
  "ollama": "connected"
}
```

### 4.2 用户管理模块

#### 4.2.1 模块功能描述
提供完整的用户CRUD操作、用户统计、邮箱查询等功能。

#### 4.2.2 运行入口
```bash
# 测试用户服务
python -m app.services.user_service

# 测试用户模型
python -m app.models.user
```

#### 4.2.3 依赖项
- PostgreSQL数据库
- SQLAlchemy ORM
- Pydantic验证

#### 4.2.4 参数配置
需要在`.env`文件中配置数据库连接：
```bash
DATABASE_URL=postgresql://username:password@localhost:5432/ai_platform
```

#### 4.2.5 运行命令示例
```bash
# 创建用户
curl -X POST http://localhost:8000/api/v1/users \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-api-key" \
  -d '{
    "name": "张三",
    "email": "zhangsan@example.com",
    "department": "财务部"
  }'

# 获取用户信息
curl http://localhost:8000/api/v1/users/{user_id} \
  -H "X-API-Key: your-api-key"

# 获取用户统计
curl http://localhost:8000/api/v1/users/stats \
  -H "X-API-Key: your-api-key"
```

#### 4.2.6 预期输出
创建用户成功：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "uuid-string",
    "name": "张三",
    "email": "zhangsan@example.com",
    "department": "财务部",
    "status": "active",
    "created_at": "2024-12-19T10:00:00Z"
  }
}
```

### 4.3 API密钥管理模块

#### 4.3.1 模块功能描述
提供API密钥的完整生命周期管理，包括生成、验证、轮换、统计等功能。

#### 4.3.2 运行入口
```bash
# 测试API密钥服务
python -m app.services.api_key_service

# 测试API密钥模型
python -m app.models.api_key
```

#### 4.3.3 依赖项
- PostgreSQL数据库
- 加密库
- 用户模块

#### 4.3.4 参数配置
```bash
# API密钥相关配置
API_KEY_EXPIRE_DAYS=365
SECRET_KEY=your-secret-key-here
```

#### 4.3.5 运行命令示例
```bash
# 生成API密钥
curl -X POST http://localhost:8000/api/v1/api-keys \
  -H "Content-Type: application/json" \
  -H "X-API-Key: admin-key" \
  -d '{
    "user_id": "user-uuid",
    "name": "财务部查询密钥",
    "permissions": ["read", "nl2sql"],
    "expires_days": 365
  }'

# 验证API密钥
curl http://localhost:8000/api/v1/api-keys/verify \
  -H "X-API-Key: your-api-key"

# 获取用户的API密钥列表
curl http://localhost:8000/api/v1/api-keys?user_id=user-uuid \
  -H "X-API-Key: admin-key"
```

### 4.4 AI Agent模块

#### 4.4.1 模块功能描述
核心AI能力模块，支持自然语言转SQL、Agent配置管理等功能。

#### 4.4.2 运行入口
```bash
# 测试NL2SQL Agent
python -m app.agents.nl2sql_agent

# 测试Agent服务
python -m app.services.agent_service

# 测试OLLAMA服务
python -m app.services.ollama_service
```

#### 4.4.3 依赖项
- OLLAMA服务 (需要先启动)
- LangGraph框架
- Agent配置数据

#### 4.4.4 参数配置
```bash
# OLLAMA服务配置
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_DEFAULT_MODEL=llama3.2
OLLAMA_TIMEOUT=30
OLLAMA_MAX_RETRIES=3
```

#### 4.4.5 OLLAMA服务启动
```bash
# 安装OLLAMA (如果未安装)
curl -fsSL https://ollama.ai/install.sh | sh

# 启动OLLAMA服务
ollama serve

# 下载模型 (在另一个终端)
ollama pull llama3.2
```

#### 4.4.6 运行命令示例
```bash
# 自然语言转SQL
curl -X POST http://localhost:8000/api/v1/agents/nl2sql \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-api-key" \
  -d '{
    "query": "查询上个月销售额超过10万的客户信息",
    "database_schema": "finance_db",
    "context": {
      "user_id": "user-uuid",
      "department": "finance"
    }
  }'

# 获取Agent列表
curl http://localhost:8000/api/v1/agents \
  -H "X-API-Key: your-api-key"

# 获取可用模型列表
curl http://localhost:8000/api/v1/models \
  -H "X-API-Key: your-api-key"
```

#### 4.4.7 预期输出
NL2SQL成功响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "request_id": "req_123456",
    "sql": "SELECT customer_name, SUM(sales_amount) FROM sales WHERE sales_date >= '2024-11-01' AND sales_date < '2024-12-01' GROUP BY customer_name HAVING SUM(sales_amount) > 100000;",
    "explanation": "查询2024年11月份销售额超过10万元的客户姓名和总销售额",
    "confidence": 0.92,
    "execution_time": 1.5
  }
}
```

### 4.5 反馈收集模块

#### 4.5.1 模块功能描述
收集用户对AI服务的使用反馈，支持评分、文本反馈、建议等。

#### 4.5.2 运行入口
```bash
# 测试反馈服务
python -m app.services.feedback_service

# 测试反馈模型
python -m app.models.feedback
```

#### 4.5.3 运行命令示例
```bash
# 提交反馈
curl -X POST http://localhost:8000/api/v1/feedback \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-api-key" \
  -d '{
    "request_id": "req_123456",
    "rating": 4,
    "is_sql_correct": true,
    "feedback_text": "生成的SQL语句正确，查询结果符合预期",
    "suggestions": "希望能够支持更复杂的聚合查询"
  }'

# 获取反馈统计
curl http://localhost:8000/api/v1/feedback/stats \
  -H "X-API-Key: your-api-key"
```

### 4.6 日志监控模块

#### 4.6.1 模块功能描述
提供API调用日志查询、统计分析、性能监控等功能。

#### 4.6.2 运行命令示例
```bash
# 查询API调用日志
curl "http://localhost:8000/api/v1/logs?limit=10&status_code=200" \
  -H "X-API-Key: your-api-key"

# 获取日志统计
curl http://localhost:8000/api/v1/logs/stats \
  -H "X-API-Key: your-api-key"

# 清理旧日志 (管理员权限)
curl -X DELETE "http://localhost:8000/api/v1/logs/cleanup?days=30" \
  -H "X-API-Key: admin-key"
```

## 5. 数据库初始化

### 5.1 手动初始化
```bash
# 运行数据库初始化脚本
python scripts/init_db.py
```

### 5.2 自动初始化 (推荐)
```bash
# 使用启动脚本，会自动检查并初始化数据库
python scripts/start.py
```

### 5.3 Docker方式初始化
```bash
# 使用Docker Compose，会自动初始化数据库
docker-compose up -d
```

## 6. 完整应用启动

### 6.1 开发环境启动

#### 方法一：直接启动
```bash
# 确保环境变量配置正确
source .env

# 启动应用
python -m app.main

# 或者使用uvicorn
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

#### 方法二：使用启动脚本 (推荐)
```bash
# 使用封装好的启动脚本
python scripts/start.py

# 或者
python -m scripts.start
```

#### 方法三：使用Poetry
```bash
poetry run python -m app.main
```

### 6.2 Docker方式启动

#### 构建并运行
```bash
# 构建镜像
docker build -t ai-platform .

# 运行容器
docker run -p 8000:8000 --env-file .env ai-platform
```

#### 使用Docker Compose (推荐)
```bash
# 启动所有服务 (应用 + PostgreSQL + Redis + OLLAMA)
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

### 6.3 生产环境部署

#### 使用Gunicorn
```bash
# 安装Gunicorn
pip install gunicorn

# 启动生产服务器
gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker -b 0.0.0.0:8000
```

#### 使用systemd服务
创建服务文件 `/etc/systemd/system/ai-platform.service`:
```ini
[Unit]
Description=AI Platform API
After=network.target

[Service]
User=www-data
Group=www-data
WorkingDirectory=/opt/ai-platform
Environment=PATH=/opt/ai-platform/venv/bin
ExecStart=/opt/ai-platform/venv/bin/gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker -b 0.0.0.0:8000
Restart=always

[Install]
WantedBy=multi-user.target
```

启动服务：
```bash
sudo systemctl enable ai-platform
sudo systemctl start ai-platform
sudo systemctl status ai-platform
```

## 7. 测试指南

### 7.1 单元测试
```bash
# 运行所有测试
pytest

# 运行特定测试文件
pytest tests/test_users.py

# 运行测试并生成覆盖率报告
pytest --cov=app --cov-report=html

# 运行测试并显示详细输出
pytest -v -s
```

### 7.2 API测试
```bash
# 使用内置测试端点
curl http://localhost:8000/docs

# 健康检查
curl http://localhost:8000/health

# API文档
curl http://localhost:8000/api/v1/docs
```

### 7.3 性能测试
```bash
# 安装性能测试工具
pip install locust

# 运行性能测试
locust -f tests/performance/locustfile.py --host=http://localhost:8000
```

## 8. 常见问题与错误处理

### 8.1 数据库连接问题

#### 错误现象
```
sqlalchemy.exc.OperationalError: (psycopg2.OperationalError) could not connect to server
```

#### 解决方案
1. 检查PostgreSQL服务是否启动
2. 验证数据库连接字符串
3. 确认数据库用户权限
4. 检查网络连接

```bash
# 检查PostgreSQL状态
sudo systemctl status postgresql

# 测试数据库连接
psql -h localhost -U username -d ai_platform
```

### 8.2 OLLAMA服务连接问题

#### 错误现象
```
Connection refused: http://localhost:11434
```

#### 解决方案
1. 启动OLLAMA服务
2. 检查端口是否正确
3. 验证模型是否已下载

```bash
# 启动OLLAMA
ollama serve

# 检查模型列表
ollama list

# 下载需要的模型
ollama pull llama3.2
```

### 8.3 API密钥认证失败

#### 错误现象
```json
{
  "code": 401,
  "message": "Invalid API key"
}
```

#### 解决方案
1. 检查API密钥是否正确
2. 验证密钥是否过期
3. 确认密钥权限

```bash
# 验证API密钥
curl http://localhost:8000/api/v1/api-keys/verify \
  -H "X-API-Key: your-api-key"
```

### 8.4 环境变量配置错误

#### 错误现象
```
ValueError: SECRET_KEY must be at least 32 characters long
```

#### 解决方案
1. 检查`.env`文件是否存在
2. 验证环境变量格式
3. 确保必要的环境变量已设置

```bash
# 检查环境变量
python -c "from app.core.config import settings; print(settings.SECRET_KEY)"
```

### 8.5 依赖包安装问题

#### 解决方案
```bash
# 更新pip
pip install --upgrade pip

# 清理缓存
pip cache purge

# 重新安装依赖
pip install -r requirements.txt --force-reinstall
```

## 9. 性能优化建议

### 9.1 数据库优化
- 使用连接池
- 添加适当的索引
- 优化查询语句
- 定期清理日志数据

### 9.2 应用优化
- 启用Redis缓存
- 使用异步操作
- 设置合理的超时时间
- 实施API限流

### 9.3 部署优化
- 使用多个工作进程
- 配置负载均衡
- 启用Gzip压缩
- 使用CDN加速

## 10. 监控与日志

### 10.1 日志配置
```bash
# 日志级别设置
LOG_LEVEL=INFO

# 日志格式
LOG_FORMAT=json

# 日志文件位置
LOG_FILE=logs/app.log
```

### 10.2 监控指标
- API响应时间
- 错误率统计
- 数据库连接数
- 内存使用情况
- OLLAMA服务状态

### 10.3 健康检查
```bash
# 系统健康检查
curl http://localhost:8000/health

# 数据库健康检查
curl http://localhost:8000/health/db

# OLLAMA服务检查
curl http://localhost:8000/health/ollama
```

## 11. 安全注意事项

### 11.1 API密钥管理
- 定期轮换API密钥
- 设置合理的过期时间
- 限制密钥权限范围
- 监控异常使用

### 11.2 数据安全
- 使用HTTPS传输
- 敏感数据加密存储
- 实施访问控制
- 定期备份数据

### 11.3 系统安全
- 及时更新依赖包
- 配置防火墙规则
- 启用访问日志
- 监控异常行为

## 12. 扩展开发指南

### 12.1 添加新的Agent
1. 在`app/agents/`目录下创建新的Agent类
2. 继承`BaseAgent`类
3. 实现必要的方法
4. 注册到Agent服务中

### 12.2 添加新的API端点
1. 在`app/api/v1/`目录下创建新的路由文件
2. 定义API端点和处理函数
3. 添加到主路由中
4. 编写相应的测试

### 12.3 扩展数据模型
1. 在`app/models/`目录下创建新的模型
2. 继承`Base`类
3. 定义字段和关系
4. 创建数据库迁移

## 13. 参考资源

### 13.1 官方文档
- [FastAPI官方文档](https://fastapi.tiangolo.com/)
- [SQLAlchemy文档](https://docs.sqlalchemy.org/)
- [Pydantic文档](https://docs.pydantic.dev/)
- [OLLAMA文档](https://ollama.ai/docs/)

### 13.2 项目相关文档
- [需求规格说明书](doc/需求规格说明书.md)
- [系统架构设计文档](doc/系统架构设计文档.md)
- [功能设计说明书](doc/功能设计说明书.md)
- [测试策略文档](doc/测试策略文档.md)

### 13.3 社区资源
- [GitHub仓库](https://github.com/your-repo/ai-platform)
- [技术交流群](https://your-chat-group-link)
- [问题反馈](https://github.com/your-repo/ai-platform/issues)

---

**注意**: 本指南会随着项目的发展而持续更新，请关注最新版本的文档。如有问题或建议，欢迎提交Issue或PR。 